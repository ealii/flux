---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: istiod
  namespace: flux-system
spec:
  chart:
    spec:
      chart: istiod
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: istio
        namespace: flux-system
      version: 1.24.x
  dependsOn:
  - name: metallb
    namespace: flux-system
  install:
    createNamespace: true
  interval: 1m0s
  releaseName: istiod
  targetNamespace: istio-system
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: istio-ingressgateway
  namespace: flux-system
spec:
  chartRef:
    kind: HelmChart
    name: gateway
    namespace: flux-system
  dependsOn:
  - name: istiod
    namespace: flux-system
  install:
    createNamespace: true
  interval: 1m0s
  releaseName: istio-ingressgateway
  targetNamespace: istio-system
  values:
    service:
      annotations:
        metallb.universe.tf/loadBalancerIPs: 192.168.59.150
      ports:
      - name: https
        port: 443
        protocol: TCP
        targetPort: 443
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: istio-egressgateway
  namespace: flux-system
spec:
  chartRef:
    kind: HelmChart
    name: gateway
    namespace: flux-system
  dependsOn:
  - name: istiod
    namespace: flux-system
  install:
    createNamespace: true
  interval: 1m0s
  releaseName: istio-egressgateway
  targetNamespace: istio-system
  values:
    service:
      type: ClusterIP
